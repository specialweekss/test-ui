# 用户数据持久化方案

## 项目概述

这是一个基于 LayaAir 的点击类游戏，包含以下核心系统：
- 玩家升级系统（等级、金钱、点击收益、升级费用）
- 助理系统（4个助理，可解锁和升级）
- 挑战系统（5个挑战关卡）

## 需要存储的数据

### 1. 玩家基础信息

| 字段名 | 类型 | 说明 | 初始值 |
|--------|------|------|--------|
| playerLevel | number | 玩家等级 | 1 |
| money | number | 当前金钱 | 0 |
| clickRewardBase | number | 点击收益基础值 | 100 |
| clickMultiplier | number | 点击收益倍率 | 1.0 |
| upgradeCost | number | 升级所需金币 | 10 |

### 2. 助理数据（数组）

每个助理需要存储：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | number | 助理ID | 1-4 |
| unlocked | boolean | 是否已解锁 | false |
| level | number | 当前等级 | 0表示未解锁，1-50表示已解锁的等级 |

**注意**：`name`、`unlockCost` 等配置数据不需要存储，可以从客户端配置读取。

### 3. 挑战数据（数组）

每个挑战需要存储：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | number | 挑战ID | 1-5 |
| completed | boolean | 是否已完成 | false |

**注意**：`name`、`requiredPower`、`reward`、`isBoss` 等配置数据不需要存储，可以从客户端配置读取。

## 后端接口设计

### 1. 获取用户游戏数据接口

**接口地址**：`GET /api/game/user-data`

**请求参数**：
- `userId` (string, 必填): 用户唯一标识
- `token` (string, 可选): 用户认证令牌（如果需要）

**请求示例**：
```
GET /api/game/user-data?userId=123456
```

**响应数据结构**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": "123456",
    "playerInfo": {
      "playerLevel": 5,
      "money": 10000,
      "clickRewardBase": 120,
      "clickMultiplier": 1.4,
      "upgradeCost": 50
    },
    "assistants": [
      {
        "id": 1,
        "unlocked": true,
        "level": 10
      },
      {
        "id": 2,
        "unlocked": true,
        "level": 5
      },
      {
        "id": 3,
        "unlocked": false,
        "level": 0
      },
      {
        "id": 4,
        "unlocked": false,
        "level": 0
      }
    ],
    "challenges": [
      {
        "id": 1,
        "completed": true
      },
      {
        "id": 2,
        "completed": false
      },
      {
        "id": 3,
        "completed": false
      },
      {
        "id": 4,
        "completed": false
      },
      {
        "id": 5,
        "completed": false
      }
    ],
    "lastUpdateTime": "2024-01-01T12:00:00Z"
  }
}
```

**响应说明**：
- 如果用户首次登录，返回默认初始数据
- 如果用户已存在数据，返回最新保存的数据

### 2. 保存用户游戏数据接口

**接口地址**：`POST /api/game/user-data`

**请求参数**：
- `userId` (string, 必填): 用户唯一标识
- `token` (string, 可选): 用户认证令牌（如果需要）
- `playerInfo` (object, 必填): 玩家基础信息
- `assistants` (array, 必填): 助理数据数组
- `challenges` (array, 必填): 挑战数据数组

**请求示例**：
```json
{
  "userId": "123456",
  "playerInfo": {
    "playerLevel": 5,
    "money": 10000,
    "clickRewardBase": 120,
    "clickMultiplier": 1.4,
    "upgradeCost": 50
  },
  "assistants": [
    {
      "id": 1,
      "unlocked": true,
      "level": 10
    },
    {
      "id": 2,
      "unlocked": true,
      "level": 5
    },
    {
      "id": 3,
      "unlocked": false,
      "level": 0
    },
    {
      "id": 4,
      "unlocked": false,
      "level": 0
    }
  ],
  "challenges": [
    {
      "id": 1,
      "completed": true
    },
    {
      "id": 2,
      "completed": false
    },
    {
      "id": 3,
      "completed": false
    },
    {
      "id": 4,
      "completed": false
    },
    {
      "id": 5,
      "completed": false
    }
  ]
}
```

**响应数据结构**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success": true,
    "lastUpdateTime": "2024-01-01T12:00:00Z"
  }
}
```

**错误响应**：
```json
{
  "code": 400,
  "message": "参数错误",
  "data": null
}
```

## 数据保存时机

建议在以下时机保存数据：

1. **游戏启动时**：从服务器加载用户数据
2. **关键操作后**：
   - 玩家升级后
   - 金钱变化后（达到一定阈值，如每次增加1000以上）
   - 助理解锁/升级后
   - 挑战完成后
3. **定期保存**：每30秒自动保存一次（防止意外退出导致数据丢失）
4. **游戏退出时**：保存最新数据

## 数据库表设计建议

### 用户游戏数据表（user_game_data）

```sql
CREATE TABLE user_game_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64) NOT NULL UNIQUE COMMENT '用户ID',
    player_level INT NOT NULL DEFAULT 1 COMMENT '玩家等级',
    money BIGINT NOT NULL DEFAULT 0 COMMENT '当前金钱',
    click_reward_base INT NOT NULL DEFAULT 100 COMMENT '点击收益基础值',
    click_multiplier DECIMAL(5,2) NOT NULL DEFAULT 1.0 COMMENT '点击收益倍率',
    upgrade_cost INT NOT NULL DEFAULT 10 COMMENT '升级所需金币',
    assistants_data JSON COMMENT '助理数据JSON',
    challenges_data JSON COMMENT '挑战数据JSON',
    last_update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_user_id (user_id),
    INDEX idx_update_time (last_update_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户游戏数据表';
```

**assistants_data JSON 格式示例**：
```json
[
  {"id": 1, "unlocked": true, "level": 10},
  {"id": 2, "unlocked": true, "level": 5},
  {"id": 3, "unlocked": false, "level": 0},
  {"id": 4, "unlocked": false, "level": 0}
]
```

**challenges_data JSON 格式示例**：
```json
[
  {"id": 1, "completed": true},
  {"id": 2, "completed": false},
  {"id": 3, "completed": false},
  {"id": 4, "completed": false},
  {"id": 5, "completed": false}
]
```

## 安全建议

1. **用户认证**：建议使用 token 或 session 进行用户身份验证
2. **数据校验**：后端需要对提交的数据进行合法性校验
   - 等级范围：1-999（根据游戏设计调整）
   - 金钱范围：0-最大值（防止负数或异常大值）
   - 助理等级：0-50
   - 数据完整性：确保 assistants 和 challenges 数组完整
3. **防作弊**：对关键数据进行合理性校验
   - 金钱增长速率检查
   - 等级提升速度检查
   - 数据一致性检查
4. **数据备份**：定期备份用户数据，防止数据丢失

## 客户端实现建议

1. **网络请求封装**：使用 LayaAir 的 `Laya.HttpRequest` 或 `fetch` API
2. **错误处理**：网络请求失败时，使用本地缓存数据
3. **数据同步**：保存失败时，将数据加入队列，稍后重试
4. **加载提示**：数据加载时显示加载动画，提升用户体验

## 接口调用示例（伪代码）

### 获取用户数据
```typescript
async function loadUserData(userId: string): Promise<UserGameData> {
    const url = `https://your-api.com/api/game/user-data?userId=${userId}`;
    const response = await fetch(url);
    const result = await response.json();
    if (result.code === 200) {
        return result.data;
    }
    throw new Error(result.message);
}
```

### 保存用户数据
```typescript
async function saveUserData(userId: string, gameData: UserGameData): Promise<boolean> {
    const url = `https://your-api.com/api/game/user-data`;
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            userId: userId,
            ...gameData
        })
    });
    const result = await response.json();
    return result.code === 200;
}
```

## 注意事项

1. **用户ID获取**：需要确定如何获取用户的唯一标识
   - 微信小游戏：使用 `wx.getUserInfo()` 或 `wx.login()` 获取 openid
   - 其他平台：使用平台提供的用户标识
2. **网络环境**：考虑弱网环境下的数据保存策略
3. **数据版本**：如果后续游戏版本更新，数据结构可能变化，需要考虑数据迁移
4. **性能优化**：避免频繁保存，使用防抖或节流机制

