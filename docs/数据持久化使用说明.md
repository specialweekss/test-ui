# 数据持久化功能使用说明

## 功能概述

已实现用户游戏数据的持久化功能，包括：
- 游戏启动时自动加载用户数据
- 数据变化时自动保存（带节流，每秒最多保存一次）
- 网络请求失败自动重试机制

## 实现文件

1. **`src/GameDataManager.ts`** - 数据管理器类
   - 负责网络请求
   - 实现节流机制（每秒最多保存一次）
   - 数据格式转换

2. **`src/Main.ts`** - 主游戏逻辑
   - 集成数据加载和保存
   - 在关键操作后触发保存

## 配置说明

### 1. API地址配置

默认API地址为 `http://localhost:8080`，可在 `GameDataManager.ts` 中修改：

```typescript
// 在 loadGameData() 方法中设置
GameDataManager.setApiBaseUrl("http://your-api-domain.com");
```

### 2. 用户ID配置

默认用户ID为 `"default_user"`，需要根据实际平台获取：

```typescript
// 在 loadGameData() 方法中设置
// 微信小游戏示例：
const wx = (window as any).wx;
if (wx && wx.getUserInfo) {
    wx.getUserInfo({
        success: (res: any) => {
            const userId = res.userInfo.openid; // 或其他唯一标识
            GameDataManager.setUserId(userId);
        }
    });
} else {
    // 其他平台或开发环境
    GameDataManager.setUserId("default_user");
}
```

## 数据保存时机

数据会在以下情况下自动保存：

1. **玩家升级后** - `onUpgradeClick()`
2. **助理解锁后** - `handleAssistantAction()` (解锁)
3. **助理升级后** - `handleAssistantAction()` (升级)
4. **挑战完成后** - `handleChallenge()`
5. **点击增加金钱后** - `setupClickHandler()` (每次点击)
6. **助理收益增加金钱后** - `updateAssistantEarnings()` (每秒)

**注意**：由于实现了节流机制，即使多次触发保存，实际网络请求最多每秒执行一次。

## 节流机制说明

### 工作原理

1. 每次调用 `saveGameData()` 时，会检查距离上次保存的时间
2. 如果距离上次保存不足1秒，将数据加入待保存队列
3. 在1秒后自动保存队列中的数据
4. 如果保存失败，数据会保留在队列中，稍后重试

### 优势

- **减少网络请求**：避免频繁保存导致服务器压力
- **自动合并**：1秒内的多次数据变化会合并为一次保存
- **失败重试**：保存失败时自动加入重试队列

## 数据加载流程

1. 游戏启动时调用 `loadGameData()`
2. 从服务器获取用户数据
3. 如果数据存在，恢复游戏状态（等级、金钱、助理、挑战等）
4. 如果数据不存在或加载失败，使用默认数据
5. 数据加载完成后，`dataLoaded` 标志设为 `true`，之后才能保存数据

## 数据格式

### 保存的数据结构

```typescript
{
    playerInfo: {
        playerLevel: number,      // 玩家等级
        money: number,             // 当前金钱
        clickRewardBase: number,  // 点击收益基础值
        clickMultiplier: number,  // 点击收益倍率
        upgradeCost: number       // 升级所需金币
    },
    assistants: [
        {
            id: number,           // 助理ID (1-4)
            unlocked: boolean,    // 是否已解锁
            level: number          // 当前等级 (0-50)
        }
    ],
    challenges: [
        {
            id: number,           // 挑战ID (1-5)
            completed: boolean     // 是否已完成
        }
    ]
}
```

## 调试说明

### 控制台日志

数据管理相关的日志会输出到控制台：

- `"开始加载游戏数据..."` - 开始加载
- `"数据加载成功，开始恢复游戏状态"` - 加载成功
- `"游戏数据恢复完成"` - 恢复完成
- `"游戏数据保存成功"` - 保存成功
- `"游戏数据保存失败，已加入重试队列"` - 保存失败

### 网络请求日志

`GameDataManager` 会输出详细的网络请求日志：

- `"开始加载用户数据，URL: ..."` - 加载请求
- `"开始保存用户数据，URL: ..."` - 保存请求
- `"节流中，数据已加入待保存队列"` - 节流触发

## 注意事项

1. **用户ID获取**：需要根据实际平台（微信小游戏、H5等）获取用户唯一标识
2. **网络环境**：弱网环境下，保存失败的数据会自动加入重试队列
3. **数据加载**：数据加载完成前不会保存数据，避免覆盖服务器数据
4. **API地址**：确保API地址正确，且支持跨域（CORS）请求

## 测试建议

1. **首次启动**：验证使用默认数据正常游戏
2. **数据保存**：进行一些操作后，检查控制台日志确认保存成功
3. **数据加载**：关闭游戏重新打开，验证数据是否正确恢复
4. **网络异常**：断开网络后操作，验证失败重试机制

## 后续优化建议

1. **本地缓存**：网络失败时使用本地缓存数据
2. **数据压缩**：如果数据量大，可以考虑压缩传输
3. **增量保存**：只保存变化的数据，减少传输量
4. **数据校验**：保存前进行数据合法性校验
5. **版本管理**：如果游戏版本更新，需要考虑数据迁移

